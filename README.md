# ICS Calendar Importer

Import ICS calendar files to Google Calendar while preserving organizer and attendee information.

**Please read this README in its entirety before running this code, as its defaults may not be
suitable for you.**

I made this to scratch my own itch, specifically to import an ICS from Fastmail into Google
Calendar. I make no warranties and YMMV, but some folks may find it helpful.

## Features

- Preserves event organizers and attendees during import
- Handles invalid or obfuscated email addresses
- Maps names to email addresses for attendees without emails
- Optional duplicate event checking using iCalUID tracking
- Interactive email validation and mapping
- Properly imports recurring events with RRULE support
- Handles recurrence exceptions (RECURRENCE-ID events)
- Skips recurring event instances to avoid duplicates
- Two-phase processing: prepare generates JSONL, process imports from JSONL
- Command-line options for calendar selection, duplicate checking, and error handling
- Checkpoint/resume functionality for interrupted imports

## Prerequisites

- Node.js installed
- Google Cloud project with Calendar API enabled
- OAuth2 credentials from Google Cloud Console

## Installation

1. Clone this repository
2. Install dependencies:

   ```bash
   npm install
   ```

3. Set up Google Calendar API:
   - Go to [Google Cloud Console](https://console.cloud.google.com/)
   - Create a new project or select existing one
   - Enable the Google Calendar API
   - Create OAuth2 credentials (Desktop application type)
   - Download credentials as `credentials.json` and place in project root

## Usage

The tool operates in two phases:

### 1. Prepare Phase - Build Email Mappings

First, scan your ICS file to identify all emails and names that need mapping:

```bash
node ics-import.js prepare data/your-calendar.ics
```

This will:

- Extract all unique email addresses and names from the ICS file
- Prompt you to provide valid emails for any invalid addresses
- Prompt you to provide emails for attendees who only have names
- Save mappings to `data/email_aliases.json` and `data/name_to_email.json`
- Generate a JSONL file (`*.jsonl`) with all converted events

### 2. Process Phase - Import to Google Calendar

After preparing email mappings, import the events using the generated JSONL file:

```bash
# Import to primary calendar (default)
node ics-import.js process data/your-calendar.ics.jsonl

# Import to specific calendar
node ics-import.js process data/your-calendar.ics.jsonl --calendar-id your-calendar-id@group.calendar.google.com

# Enable duplicate checking and error skipping
node ics-import.js process data/your-calendar.ics.jsonl --check-duplicates --skip-errors

# Combine all options
node ics-import.js process data/your-calendar.ics.jsonl \
  --check-duplicates --skip-errors \
  --calendar-id work@group.calendar.google.com
```

This will:

- Load the prepared email mappings and pre-converted events from the JSONL file
- Authenticate with Google Calendar (first time only)
- Import all events with corrected email addresses
- Skip events that already exist in your calendar (if duplicate checking is enabled)

## File Structure

- `ics-import.js` - Main application script
- `credentials.json` - Google OAuth2 app credentials (you provide)
- `data/` - Directory containing:
  - `*.ics` - ICS files to import
  - `*.jsonl` - Pre-converted events (auto-generated by prepare)
  - `*.ics.position` - Checkpoint files for resume functionality (auto-generated)
  - `tokens.json` - Saved user OAuth2 authentication tokens (auto-generated)
  - `email_aliases.json` - Email address mappings (auto-generated)
  - `name_to_email.json` - Name to email mappings (auto-generated)

## Command Line Options

Use `--help` to see all available options:

```bash
node ics-import.js --help
```

### Available Options:

- `--calendar-id <id>` - Target calendar ID (default: primary)
- `--check-duplicates` - Enable duplicate event checking (slower but safer)
- `--skip-errors` - Skip failed events and continue importing
- `--help, -h` - Show help message

## Resume/Checkpoint Feature

The importer automatically saves progress during imports, allowing you to resume if the process is interrupted. A sidecar file (`*.position`) tracks the last successfully imported event.

- **Automatic Resume**: If an import fails or is stopped, simply run the same command again to resume from where it left off
- **Sidecar Files**: Progress is saved in `data/calendar.ics.position` files
- **Clean Completion**: Checkpoint files are automatically removed when imports complete successfully

Example:

```bash
# Start import (creates checkpoint file automatically)
$ node ics-import.js process data/calendar.ics.jsonl
üìÖ Processing events from: data/calendar.ics.jsonl
Found 1000 event(s) to process
‚ö° Duplicate checking is DISABLED (faster imports)

‚úÖ Imported: Meeting 1
‚úÖ Imported: Meeting 2
^C # Process interrupted at event 2

# Resume import (automatically continues from event 3)
$ node ics-import.js process data/calendar.ics.jsonl
üìÖ Processing events from: data/calendar.ics.jsonl
Found 1000 event(s) to process
‚ö° Duplicate checking is DISABLED (faster imports)
üìå Found checkpoint: Resuming from event 3

‚úÖ Imported: Meeting 3
# ... continues from where it left off
```

## Example Workflow

```bash
# Step 1: Prepare email mappings
$ node ics-import.js prepare data/calendar.ics
üöÄ PREPARE MODE: Building email and name mappings

üîç Scanning ICS file for emails and names: data/calendar.ics
üìä Scanned 150 events
   üìß Found 25 unique emails
   üë§ Found 5 unique names (no email)

üìß Processing emails...
‚úì john.doe@example.com ‚Üí john.doe@example.com (valid)
‚ùå Invalid email found: "INVALID_EMAIL_TOKEN"
Enter valid email for "INVALID_EMAIL_TOKEN": jane.smith@example.com
‚úÖ Mapped: INVALID_EMAIL_TOKEN ‚Üí jane.smith@example.com

üíæ Saved 25 email aliases to data/email_aliases.json

# Step 2: Import to Google Calendar
$ node ics-import.js process data/calendar.ics.jsonl
üöÄ PROCESS MODE: Importing to Google Calendar

‚úÖ Credentials loaded successfully
‚úÖ Using saved authorization tokens
üìÖ Processing events from: data/calendar.ics.jsonl
Found 150 event(s) to process
‚ö° Duplicate checking is DISABLED (faster imports)

‚úÖ Imported: Team Meeting
   üìß Organizer: John Doe (john.doe@example.com)
   üë• Attendees: 5

üéâ Import complete!
   ‚úÖ 145 events imported
   ‚è≠Ô∏è  5 events skipped
```

## Recurring Events

The importer properly handles recurring events:

- **Main recurring events** with RRULE properties are imported with their recurrence rules intact
- **Recurrence exceptions** (events with RECURRENCE-ID) are imported as modified instances of recurring events
- **Recurring event instances** (UIDs ending in `_R[date]`) are automatically skipped to prevent duplicates
- Google Calendar will generate all occurrences based on the RRULE from the main event

Example: If your ICS contains:

- `Tennis lesson` (UID: `84976jsiu3i47tdldj24hrfa67@google.com`) with `RRULE:FREQ=WEEKLY`
- `Tennis lesson (Moved)` with `RECURRENCE-ID:20220928T200000Z` - exception
- `Tennis lesson` (UID: `84976jsiu3i47tdldj24hrfa67_R20220928T200000@google.com`) - instance

The main recurring event and the exception will be imported, while the instance will be skipped.

## Testing

The project includes Jest tests covering what can be tested without hitting Google's APIs.

- ICS file parsing and event conversion
- Email validation and mapping
- JSONL generation and processing
- Checkpoint functionality
- Command line option handling
- RRULE conversion and edge cases

Run tests with:

```bash
npm test
```

## License

MIT
